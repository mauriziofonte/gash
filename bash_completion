#!/usr/bin/env bash

# Bash completion for Gash functions

# Ensure that Gash functions are available by checking for one core Gash function.
if ! declare -f git_add_tag >/dev/null 2>&1; then
    return
fi

# -----------------------------------------------------------------------------
# Internal Helpers
# -----------------------------------------------------------------------------

# Check if a function name should be excluded from public list.
# Returns 0 (true) if should be excluded, 1 (false) if should be included.
__gash_is_internal_function() {
    local fn="${1-}"
    [[ -z "$fn" ]] && return 0

    case "$fn" in
        __*|_*)
            return 0
            ;;
        needs_help|needs_confirm_prompt|print_error)
            return 0
            ;;
    esac

    return 1
}

# Build a whitespace-separated list of "public" Gash functions.
# Prefer __GASH_ADDED_FUNCS (computed by gash.sh) so we don't include user-defined functions.
__gash_public_functions() {
    local out=""
    local fn

    if [[ -n "${__GASH_ADDED_FUNCS-}" ]]; then
        local IFS=$'\n'
        for fn in ${__GASH_ADDED_FUNCS}; do
            __gash_is_internal_function "$fn" && continue
            out+="$fn "
        done

        printf '%s' "${out% }"
        return 0
    fi

    # Fallback: keep a minimal set if we can't detect the added functions.
    printf '%s' "disk_usage files_largest dirs_largest dirs_find_large history_grep git_add_tag git_delete_tag gash_doctor gash archive_extract file_backup"
}

# -----------------------------------------------------------------------------
# Completion Function
# -----------------------------------------------------------------------------

# Completion handler for Gash functions.
# Dispatches to per-function completion based on COMP_WORDS[0].
__gash_complete() {
    local cur="${COMP_WORDS[COMP_CWORD]}"
    local cmd="${COMP_WORDS[0]}"

    case "$cmd" in
        # Git tag completion
        git_add_tag|git_delete_tag|git_list_tags)
            if type -P git >/dev/null 2>&1 && git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
                COMPREPLY=($(compgen -W "$(git tag -l 2>/dev/null)" -- "$cur"))
            else
                COMPREPLY=()
            fi
            ;;

        # Directory completion
        files_largest|dirs_largest|dirs_find_large|dirs_list_empty|\
        docker_compose_check|docker_compose_upgrade|docker_compose_scan|mkdir_cd)
            COMPREPLY=($(compgen -d -- "$cur"))
            ;;

        # File completion
        archive_extract|file_backup|git_dump_revisions)
            COMPREPLY=($(compgen -f -- "$cur"))
            ;;

        # Gash reference card sections
        gash)
            COMPREPLY=($(compgen -W "git files system docker nav navigation llm php gash management all help" -- "$cur"))
            ;;

        # AI provider completion (first argument only)
        ai_ask|ai_query)
            if (( COMP_CWORD == 1 )); then
                COMPREPLY=($(compgen -W "claude gemini" -- "$cur"))
            else
                COMPREPLY=()
            fi
            ;;

        # Everything else: empty COMPREPLY lets -o default provide file completion
        *)
            COMPREPLY=()
            ;;
    esac
}

# -----------------------------------------------------------------------------
# Enable Completion
# -----------------------------------------------------------------------------

# Activate completion for each public Gash function.
#
# NOTE: Completion is NOT registered for bash aliases (dsa, gat, flf, etc.).
# Bash expands aliases BEFORE consulting completion specs, so
# `complete -F handler alias_name` is silently ignored. This is a bash
# limitation, not a Gash bug. Alias users get default readline completion.
__gash_enable_completion() {
    local fn

    if [[ -n "${__GASH_ADDED_FUNCS-}" ]]; then
        local IFS=$'\n'
        for fn in ${__GASH_ADDED_FUNCS}; do
            __gash_is_internal_function "$fn" && continue
            complete -o default -F __gash_complete "$fn"
        done
    else
        # Fallback registration for common functions
        local fn_list="git_add_tag git_delete_tag git_list_tags disk_usage files_largest dirs_largest dirs_find_large history_grep gash_doctor gash archive_extract file_backup"
        for fn in $fn_list; do
            complete -o default -F __gash_complete "$fn"
        done
    fi
}

__gash_enable_completion
unset -f __gash_enable_completion
